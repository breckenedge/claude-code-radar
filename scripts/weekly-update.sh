#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="$HOME/code/claude-code-radar"
BRANCH="weekly-update-$(date +%Y-%m-%d)"
LOG_FILE="$REPO_DIR/scripts/logs/$(date +%Y-%m-%d).log"

mkdir -p "$REPO_DIR/scripts/logs"

cd "$REPO_DIR"

# Make sure we're on a clean main
git checkout main
git pull origin main

# Create a branch for the update
git checkout -b "$BRANCH"

# Run Claude Code in non-interactive mode
claude -p \
  --allowedTools "Bash(git:*) Edit Read Write Grep Glob WebSearch WebFetch" \
  --max-budget-usd 5 \
  "You are updating the Claude Code Technology Radar in README.md.

Your job:
1. Read the current README.md carefully
2. Research what's changed in the Claude Code ecosystem this past week (web search for news, releases, blog posts, GitHub activity)
3. For each existing blip, check if the ring placement still makes sense
4. Look for new blips that should be added (remember the inclusion criteria in 'What's On vs Off the Radar')
5. Look for blips that should move rings or be removed
6. Update README.md with any changes
7. Keep changes minimal and justified — don't churn for the sake of churn
8. If nothing meaningful changed this week, say so and make no edits

Rules:
- Stay focused on the Claude Code ecosystem, not general AI coding
- No hype stats, no marketing language
- Link new blips to their official URLs
- Keep notes concise

After making changes (if any), commit them with a descriptive message. Do NOT push." \
  2>&1 | tee "$LOG_FILE"

# If there are commits on the branch beyond main, push and open a PR
if [ "$(git rev-list main.."$BRANCH" --count)" -gt 0 ]; then
  git push -u origin "$BRANCH"
  gh pr create \
    --title "Weekly radar update — $(date +%B\ %d,\ %Y)" \
    --body "$(cat <<'EOF'
## Summary
Automated weekly radar update. Review the diff for changes.

Generated by `scripts/weekly-update.sh` using Claude Code headless mode.
EOF
)"
  echo "PR created for $BRANCH"
else
  echo "No changes this week."
  git checkout main
  git branch -d "$BRANCH"
fi
